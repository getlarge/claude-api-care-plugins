name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (build and test without creating release)'
        required: false
        default: true
        type: boolean
      version:
        description: 'Version tag for dry run (e.g., v1.0.0-test)'
        required: false
        default: 'v0.0.0-dry-run'
        type: string

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-release
  cancel-in-progress: true

env:
  HUSKY: 0

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build all packages
        run: npm run build

      - name: Run tests
        run: npm test

      - name: Verify bundles exist
        run: |
          echo "Checking openapi-reviewer bundles..."
          ls -la plugins/aip-api-design/openapi-reviewer/dist/
          test -f plugins/aip-api-design/openapi-reviewer/dist/reviewer.bundle.js
          test -f plugins/aip-api-design/openapi-reviewer/dist/cli.bundle.js
          test -f plugins/aip-api-design/openapi-reviewer/dist/discover.bundle.js

          echo "Checking mcp-server bundles..."
          ls -la plugins/aip-api-design/mcp-server/dist/
          test -f plugins/aip-api-design/mcp-server/dist/server.bundle.js
          test -f plugins/aip-api-design/mcp-server/dist/stdio.bundle.js
          test -f plugins/aip-api-design/mcp-server/dist/worker.bundle.js

          echo "All bundles verified!"

      - name: Smoke test - CLI help
        run: |
          node plugins/aip-api-design/openapi-reviewer/dist/cli.bundle.js --help
          echo "CLI bundle works!"

      - name: Smoke test - MCP server starts
        run: |
          # Start server in background, wait, then check health
          timeout 10 node plugins/aip-api-design/mcp-server/dist/server.bundle.js &
          sleep 3
          curl -sf http://localhost:4000/health || echo "Health check (expected to fail in CI without full setup)"
          echo "Server bundle starts!"

      - name: Create release archives
        run: |
          # Create dist archive for openapi-reviewer
          cd plugins/aip-api-design/openapi-reviewer
          tar -czvf ../../../openapi-reviewer-dist.tar.gz dist/
          cd ../../..

          # Create dist archive for mcp-server
          cd plugins/aip-api-design/mcp-server
          tar -czvf ../../../mcp-server-dist.tar.gz dist/
          cd ../../..

          # Create combined archive
          mkdir -p release-dist
          cp plugins/aip-api-design/openapi-reviewer/dist/*.bundle.js release-dist/
          cp plugins/aip-api-design/mcp-server/dist/*.bundle.js release-dist/
          tar -czvf aip-plugin-bundles.tar.gz release-dist/

      - name: Generate checksums
        run: |
          sha256sum openapi-reviewer-dist.tar.gz > checksums.txt
          sha256sum mcp-server-dist.tar.gz >> checksums.txt
          sha256sum aip-plugin-bundles.tar.gz >> checksums.txt
          # Also checksum individual bundles
          sha256sum plugins/aip-api-design/openapi-reviewer/dist/*.bundle.js >> checksums.txt
          sha256sum plugins/aip-api-design/mcp-server/dist/*.bundle.js >> checksums.txt
          echo "=== Checksums ==="
          cat checksums.txt

      - name: Upload artifacts (for dry run inspection)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            openapi-reviewer-dist.tar.gz
            mcp-server-dist.tar.gz
            aip-plugin-bundles.tar.gz
            checksums.txt
          retention-days: 7

      - name: Create Release
        if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.dry_run == false)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event_name == 'push' && github.ref_name || inputs.version }}
          generate_release_notes: true
          draft: ${{ github.event_name == 'workflow_dispatch' }}
          files: |
            openapi-reviewer-dist.tar.gz
            mcp-server-dist.tar.gz
            aip-plugin-bundles.tar.gz
            checksums.txt
            plugins/aip-api-design/openapi-reviewer/dist/reviewer.bundle.js
            plugins/aip-api-design/openapi-reviewer/dist/cli.bundle.js
            plugins/aip-api-design/openapi-reviewer/dist/discover.bundle.js
            plugins/aip-api-design/mcp-server/dist/server.bundle.js
            plugins/aip-api-design/mcp-server/dist/stdio.bundle.js
            plugins/aip-api-design/mcp-server/dist/worker.bundle.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Release Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Bundles" >> $GITHUB_STEP_SUMMARY
          echo "| Package | Bundle | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|------|" >> $GITHUB_STEP_SUMMARY
          for f in plugins/aip-api-design/openapi-reviewer/dist/*.bundle.js plugins/aip-api-design/mcp-server/dist/*.bundle.js; do
            size=$(du -h "$f" | cut -f1)
            name=$(basename "$f")
            pkg=$(echo "$f" | grep -o 'openapi-reviewer\|mcp-server')
            echo "| $pkg | $name | $size |" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Checksums" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat checksums.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
